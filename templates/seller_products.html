{% extends "base.html" %}
{% block title %}Ù…Ø­ØµÙˆÙ„Ø§Øª Ù…Ù†{% endblock %}
{% block content %}
<div class="container" style="margin-top:1rem;">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h2 style="margin:0;">Ù…Ø­ØµÙˆÙ„Ø§Øª Ù…Ù†</h2>
    <button id="addBtn" class="profile-btn">â• Ù…Ø­ØµÙˆÙ„ Ø¬Ø¯ÛŒØ¯</button>
  </div>

  {% if products %}
  <section class="products" id="pGrid" style="margin-top:1rem;">
    <div id="sMenu" class="admin-menu">
  <button data-act="inc">Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ¬ÙˆØ¯ÛŒ</button>
  <button data-act="dec">Ú©Ø§Ù‡Ø´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ</button>
  <button data-act="edit">ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø´Ø®ØµØ§Øª</button>
  <button data-act="del" class="danger">Ø­Ø°Ù</button>
</div>

    {% for p in products %}
     <div class="product-card{% if p.stock<5 %} low-stock{% endif %}"
     data-id="{{ p.id }}"
     data-price="{{ p.price }}"
     data-desc="{{ p.description|e }}">

        <div class="img-wrap">
          <img src="{{ p.image }}" alt="{{ p.name }}" loading="lazy">
          <span class="stock-badge{% if p.stock==0 %} out{% elif p.stock<5 %} low{% endif %}">
            {{ p.stock }}
          </span>
        </div>
        <div class="card-body">
          <h3 class="prod-title">{{ p.name }}</h3>
          <div class="price-stock">
            <span class="price">{{ '{:,}'.format(p.price) }} ØªÙˆÙ…Ø§Ù†</span>
          </div>
        </div>
      </div>
    {% endfor %}
  </section>
  {% else %}
    <p style="margin-top:2rem;text-align:center;">Ù‡Ù†ÙˆØ² Ù…Ø­ØµÙˆÙ„ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒ ğŸŒ±</p>
  {% endif %}
</div>

<!-- ==== Add Product Modal ==== -->
<div id="addOverlay" class="modal-overlay">
  <div class="modal">
    <button class="close-btn" id="addClose">âœ–</button>
    <h2 style="text-align:center;">Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„</h2>
    <form id="addForm">
      <input name="name" placeholder="Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„" required>
      <input name="price" type="number" placeholder="Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)" required>
      <input name="stock" type="number" placeholder="Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§ÙˆÙ„ÛŒÙ‡" required>
      <textarea name="description" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª" rows="3" style="resize:none;padding:.5rem;border:1px solid #ddd;border-radius:var(--radius);"></textarea>
      <input name="image" type="file" accept="image/*" required>
      <button type="submit" class="profile-btn">Ø«Ø¨Øª</button>
    </form>
  </div>
</div>


<div id="editOverlay" class="modal-overlay">
  <div class="modal">
    <button class="close-btn" id="editClose">âœ–</button>
    <h2 style="text-align:center;">ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø­ØµÙˆÙ„</h2>
    <form id="editForm">
      <input name="name" required>
      <input name="price" type="number" required>
      <input name="stock" type="number" required>
      <textarea name="description" rows="3" style="resize:none;padding:.5rem;border:1px solid #ddd;border-radius:var(--radius);"></textarea>
      <button type="submit" class="profile-btn">Ø°Ø®ÛŒØ±Ù‡</button>
    </form>
  </div>
</div>



<script>
/* ---------- Modal Ú©Ù†ØªØ±Ù„ ---------- */
const ov=document.getElementById('addOverlay');
document.getElementById('addBtn').onclick=()=>ov.classList.add('show');
document.getElementById('addClose').onclick=()=>ov.classList.remove('show');
ov.onclick=e=>{if(e.target===ov) ov.classList.remove('show');};

/* ---------- Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù… ---------- */
document.getElementById('addForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const fd=new FormData(e.target);
  const res=await fetch('/api/seller/product',{method:'POST',body:fd});
  if(res.ok){
    showToast('Ù…Ø­ØµÙˆÙ„ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ âœ…');
    setTimeout(()=>location.reload(),800);
  }else{
    const err=await res.json();
    showToast('Ø®Ø·Ø§: '+err.detail,'error');
  }
});

/* ---------- Ù…Ù†ÙˆÛŒ Ø±Ø§Ø³Øªâ€ŒÚ©Ù„ÛŒÚ© ---------- */
const menu=document.getElementById('sMenu');
let target=null;

document.querySelectorAll('.product-card').forEach(card=>{
  card.addEventListener('contextmenu',e=>{
    e.preventDefault();
    target=card;
    menu.style.top=e.pageY+'px';
    menu.style.left=e.pageX+'px';
    menu.style.display='block';
  });
});
document.addEventListener('click',()=>menu.style.display='none');

menu.addEventListener('click',async e=>{
  const act=e.target.dataset.act;
  if(!act) return;
  const pid = target.dataset.id;
  if(!pid){
  showToast('Ø®Ø·Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ: Ø´Ù†Ø§Ø³Ù‡ Ù…Ø­ØµÙˆÙ„ ÛŒØ§ÙØª Ù†Ø´Ø¯','error');
  return;
}

  menu.style.display='none';

  // inc / dec
  if(act==='inc' || act==='dec'){
    const qty = await askQuantity(act);
    if(!qty) return;
    const step = act==='inc'? qty : -qty;
    const res = await fetch(`/api/seller/product/${pid}/stock?step=${step}`,{method:'POST'});
    if(res.ok){
      showToast('âœ… Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯');
      setTimeout(()=>location.reload(),600);
    }
    return;
  }

  // delete
  if(act==='del'){
    const ok=await showConfirm('Ù…Ø­ØµÙˆÙ„ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ');
    if(!ok) return;
    const res=await fetch(`/api/seller/product/${pid}`,{method:'DELETE'});
    if(res.ok) target.remove();
    return;
  }

  // edit
  if(act==='edit'){
    const ov=document.getElementById('editOverlay');
    const form=document.getElementById('editForm');
    // prefill
form.name.value  = target.querySelector('.prod-title').textContent.trim();
form.price.value = target.dataset.price;
form.stock.value = parseInt(target.querySelector('.stock-badge').textContent,10);
form.description.value = target.dataset.desc || '';

    ov.classList.add('show');
    document.getElementById('editClose').onclick=()=>ov.classList.remove('show');
    ov.onclick=e=>{if(e.target===ov) ov.classList.remove('show');};

    form.onsubmit = async ev=>{
      ev.preventDefault();
      const fd=new FormData(form);
      const res=await fetch(`/api/seller/product/${pid}/update`,{method:'POST',body:fd});
      if(res.ok){
        showToast('âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
        setTimeout(()=>location.reload(),600);
      }else{
        const err=await res.json();
        showToast('âŒ '+err.detail,'error');
      }
    };
  }
});

</script>


{% endblock %}
